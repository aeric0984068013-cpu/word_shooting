<!doctype html>
<html lang="zh-Hant" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å–®å­—çˆ†ç ´ç‹</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
        body {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .game-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .falling-word {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            animation: fall linear forwards;
            user-select: none;
        }

        .falling-word:hover {
            transform: scale(1.1);
        }

        .falling-word.explode {
            animation: explode 0.5s forwards;
        }

        @keyframes fall {
            from {
                top: -10%;
            }
            to {
                top: 110%;
            }
        }

        @keyframes explode {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .choice-button {
            transition: all 0.2s;
        }

        .choice-button:active {
            transform: scale(0.95);
        }

        .choice-button.correct {
            animation: correctPulse 0.5s;
        }

        .choice-button.wrong {
            animation: wrongShake 0.5s;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .particle {
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            pointer-events: none;
            animation: particle-burst 0.6s ease-out forwards;
        }

        @keyframes particle-burst {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--tx), var(--ty)) scale(0);
                opacity: 0;
            }
        }

        .combo-badge {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4rem;
            font-weight: 900;
            z-index: 1000;
            animation: comboPop 0.8s ease-out forwards;
            pointer-events: none;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }

        @keyframes comboPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        .toast.show {
            opacity: 1;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full">
  <div class="h-full w-full overflow-hidden" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><!-- éŠæˆ²æ¨™é¡Œèˆ‡è³‡è¨Š -->
   <header class="absolute top-0 left-0 right-0 z-10 p-4 flex justify-between items-center">
    <div>
     <h1 class="text-3xl font-black text-white drop-shadow-lg" id="gameTitle">å–®å­—çˆ†ç ´ç‹ ğŸ’¥</h1>
     <p class="text-white text-sm mt-1 opacity-90">é»æ“Šæ­£ç¢ºçš„ä¸­æ–‡è§£é‡‹ï¼</p>
    </div>
    <div class="text-right">
     <div class="text-white text-sm opacity-90" id="scoreLabel">
      åˆ†æ•¸
     </div>
     <div class="text-4xl font-black text-white drop-shadow-lg" id="scoreDisplay">
      0
     </div>
     <div class="text-white text-xs mt-1" id="comboDisplay">
      é€£æ“Š: 0
     </div>
    </div>
   </header><!-- éŠæˆ²å€åŸŸ -->
   <main class="h-full w-full pt-28 pb-32">
    <div id="gameArea" class="game-container h-full"></div>
   </main><!-- é¸æ“‡æŒ‰éˆ•å€ -->
   <footer class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black/30 to-transparent">
    <div id="choicesContainer" class="max-w-4xl mx-auto grid grid-cols-2 gap-3"><!-- é¸æ“‡æŒ‰éˆ•å°‡å‹•æ…‹ç”Ÿæˆ -->
    </div>
   </footer><!-- é–‹å§‹/çµæŸç•«é¢ -->
   <div id="startScreen" class="absolute inset-0 flex items-center justify-center bg-black/80 z-50">
    <div class="text-center p-8">
     <h2 class="text-5xl font-black text-white mb-4">å–®å­—çˆ†ç ´ç‹ ğŸ’¥</h2>
     <p class="text-white text-lg mb-2">é»æ“Šæ­£ç¢ºçš„ä¸­æ–‡è§£é‡‹æ“Šè½å–®å­—ï¼</p>
     <p class="text-yellow-300 text-sm mb-8">é€Ÿåº¦æœƒè¶Šä¾†è¶Šå¿«ï¼ŒæŒ‘æˆ°ä½ çš„æ¥µé™ï¼</p>
     <div id="addWordsSection" class="mb-8">
      <div class="bg-white/10 backdrop-blur rounded-lg p-6 max-w-md mx-auto">
       <h3 class="text-white text-xl font-bold mb-4">æ–°å¢å–®å­—åº«</h3>
       <form id="addWordForm" class="space-y-3"><input type="text" id="wordInput" placeholder="è‹±æ–‡å–®å­—" class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border-2 border-white/30 focus:border-white focus:outline-none" required> <input type="text" id="defInput" placeholder="ä¸­æ–‡è§£é‡‹" class="w-full px-4 py-2 rounded-lg bg-white/20 text-white placeholder-white/60 border-2 border-white/30 focus:border-white focus:outline-none" required> <button type="submit" id="addWordBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition"> â• æ–°å¢å–®å­— </button>
       </form>
       <div class="text-white/80 text-sm mt-3" id="wordCount">
        å·²æœ‰ 0 å€‹å–®å­—
       </div>
      </div>
     </div><button id="startButton" class="bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-black text-2xl py-4 px-12 rounded-full shadow-2xl transform hover:scale-110 transition disabled:opacity-50 disabled:cursor-not-allowed"> ğŸš€ é–‹å§‹éŠæˆ² </button>
    </div>
   </div>
  </div><!-- Toast é€šçŸ¥ -->
  <div id="toast" class="toast"></div>
  <script>
        // å…§å»ºå–®å­—åº«
        const builtInWords = [
            { word: "Apple", definition: "è˜‹æœ" },
            { word: "Book", definition: "æ›¸" },
            { word: "Cat", definition: "è²“" },
            { word: "Dog", definition: "ç‹—" },
            { word: "Happy", definition: "å¿«æ¨‚çš„" },
            { word: "Water", definition: "æ°´" },
            { word: "Friend", definition: "æœ‹å‹" },
            { word: "Love", definition: "æ„›" },
            { word: "Music", definition: "éŸ³æ¨‚" },
            { word: "School", definition: "å­¸æ ¡" },
            { word: "Dream", definition: "å¤¢æƒ³" },
            { word: "Beautiful", definition: "ç¾éº—çš„" },
            { word: "Strong", definition: "å¼·å£¯çš„" },
            { word: "Smart", definition: "è°æ˜çš„" },
            { word: "Fire", definition: "ç«" },
            { word: "Ice", definition: "å†°" },
            { word: "Sun", definition: "å¤ªé™½" },
            { word: "Moon", definition: "æœˆäº®" },
            { word: "Star", definition: "æ˜Ÿæ˜Ÿ" },
            { word: "Ocean", definition: "æµ·æ´‹" },
            { word: "Mountain", definition: "å±±" },
            { word: "River", definition: "æ²³æµ" },
            { word: "Forest", definition: "æ£®æ—" },
            { word: "Flower", definition: "èŠ±" },
            { word: "Tree", definition: "æ¨¹" },
            { word: "Bird", definition: "é³¥" },
            { word: "Fish", definition: "é­š" },
            { word: "Butterfly", definition: "è´è¶" },
            { word: "Rainbow", definition: "å½©è™¹" },
            { word: "Thunder", definition: "é›·" },
            { word: "Lightning", definition: "é–ƒé›»" },
            { word: "Cloud", definition: "é›²" },
            { word: "Wind", definition: "é¢¨" },
            { word: "Rain", definition: "é›¨" },
            { word: "Snow", definition: "é›ª" },
            { word: "Summer", definition: "å¤å¤©" },
            { word: "Winter", definition: "å†¬å¤©" },
            { word: "Spring", definition: "æ˜¥å¤©" },
            { word: "Autumn", definition: "ç§‹å¤©" },
            { word: "Morning", definition: "æ—©æ™¨" },
            { word: "Night", definition: "å¤œæ™š" },
            { word: "Time", definition: "æ™‚é–“" },
            { word: "Hope", definition: "å¸Œæœ›" },
            { word: "Peace", definition: "å’Œå¹³" },
            { word: "Freedom", definition: "è‡ªç”±" },
            { word: "Courage", definition: "å‹‡æ°£" },
            { word: "Wisdom", definition: "æ™ºæ…§" },
            { word: "Journey", definition: "æ—…ç¨‹" },
            { word: "Adventure", definition: "å†’éšª" },
            { word: "Magic", definition: "é­”æ³•" }
        ];

        // å…¨åŸŸç‹€æ…‹
        let words = [];
        let gameActive = false;
        let score = 0;
        let combo = 0;
        let currentWord = null;
        let currentChoices = [];
        let spawnInterval = null;
        let difficultyLevel = 1;
        let fallDuration = 8000;

        // é è¨­é…ç½®
        const defaultConfig = {
            game_title: "å–®å­—çˆ†ç ´ç‹ ğŸ’¥",
            start_button_text: "ğŸš€ é–‹å§‹éŠæˆ²",
            score_label: "åˆ†æ•¸",
            background_gradient_start: "#667eea",
            background_gradient_end: "#764ba2",
            word_color: "#fbbf24",
            button_color: "#10b981",
            text_color: "#ffffff"
        };

        // DOM å…ƒç´ 
        const gameArea = document.getElementById('gameArea');
        const choicesContainer = document.getElementById('choicesContainer');
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const comboDisplay = document.getElementById('comboDisplay');
        const addWordForm = document.getElementById('addWordForm');
        const wordInput = document.getElementById('wordInput');
        const defInput = document.getElementById('defInput');
        const addWordBtn = document.getElementById('addWordBtn');
        const wordCount = document.getElementById('wordCount');

        // Toast é€šçŸ¥
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.backgroundColor = type === 'success' ? '#10b981' : '#ef4444';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // å‰µå»ºç²’å­æ•ˆæœ
        function createParticles(x, y, color) {
            for (let i = 0; i < 12; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.backgroundColor = color;
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                
                const angle = (i / 12) * Math.PI * 2;
                const distance = 50 + Math.random() * 50;
                particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                
                gameArea.appendChild(particle);
                setTimeout(() => particle.remove(), 600);
            }
        }

        // é¡¯ç¤ºé€£æ“Šç‰¹æ•ˆ
        function showComboEffect() {
            if (combo < 5) return;
            
            const badge = document.createElement('div');
            badge.className = 'combo-badge';
            badge.style.color = '#fbbf24';
            badge.textContent = `${combo}x COMBO!`;
            document.body.appendChild(badge);
            setTimeout(() => badge.remove(), 800);
        }

        // ç”Ÿæˆéš¨æ©Ÿé¸é …
        function generateChoices(correctDef) {
            const choices = [correctDef];
            const availableWords = words.filter(w => w.definition !== correctDef);
            
            while (choices.length < 4 && availableWords.length > 0) {
                const randomIndex = Math.floor(Math.random() * availableWords.length);
                const def = availableWords[randomIndex].definition;
                if (!choices.includes(def)) {
                    choices.push(def);
                }
                availableWords.splice(randomIndex, 1);
            }
            
            // ï¿½ï¿½äº‚é †åº
            return choices.sort(() => Math.random() - 0.5);
        }

        // æ›´æ–°é¸æ“‡æŒ‰éˆ•
        function updateChoices() {
            if (!currentWord || currentChoices.length === 0) return;
            
            choicesContainer.innerHTML = '';
            currentChoices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'choice-button bg-white/20 backdrop-blur hover:bg-white/30 text-white font-bold py-4 px-6 rounded-xl text-lg';
                button.textContent = choice;
                button.onclick = () => handleChoice(choice);
                choicesContainer.appendChild(button);
            });
        }

        // è™•ç†é¸æ“‡
        function handleChoice(selectedDef) {
            if (!currentWord) return;
            
            const allWords = document.querySelectorAll('.falling-word');
            let foundMatch = false;
            
            allWords.forEach(wordEl => {
                const wordData = JSON.parse(wordEl.dataset.word);
                if (wordData.definition === selectedDef) {
                    foundMatch = true;
                    const rect = wordEl.getBoundingClientRect();
                    
                    if (wordData.definition === currentWord.definition) {
                        // æ­£ç¢ºç­”æ¡ˆ
                        wordEl.classList.add('explode');
                        createParticles(rect.left + rect.width / 2, rect.top + rect.height / 2, '#10b981');
                        
                        combo++;
                        score += 10 * combo;
                        scoreDisplay.textContent = score;
                        comboDisplay.textContent = `é€£æ“Š: ${combo}`;
                        showComboEffect();
                        
                        // æŒ‰éˆ•æ­£ç¢ºåé¥‹
                        const buttons = choicesContainer.querySelectorAll('.choice-button');
                        buttons.forEach(btn => {
                            if (btn.textContent === selectedDef) {
                                btn.classList.add('correct');
                            }
                        });
                        
                        setTimeout(() => wordEl.remove(), 500);
                        spawnWord();
                    } else {
                        // éŒ¯èª¤ç­”æ¡ˆ
                        combo = 0;
                        comboDisplay.textContent = `é€£æ“Š: 0`;
                        
                        // æŒ‰éˆ•éŒ¯èª¤åé¥‹
                        const buttons = choicesContainer.querySelectorAll('.choice-button');
                        buttons.forEach(btn => {
                            if (btn.textContent === selectedDef) {
                                btn.classList.add('wrong');
                            }
                        });
                    }
                }
            });
        }

        // ç”Ÿæˆä¸‹è½çš„å–®å­—
        function spawnWord() {
            if (!gameActive || words.length < 4) return;
            
            const randomWord = words[Math.floor(Math.random() * words.length)];
            currentWord = randomWord;
            currentChoices = generateChoices(randomWord.definition);
            updateChoices();
            
            const wordEl = document.createElement('div');
            wordEl.className = 'falling-word';
            wordEl.textContent = randomWord.word;
            wordEl.style.left = Math.random() * (window.innerWidth - 200) + 'px';
            wordEl.style.backgroundColor = '#fbbf24';
            wordEl.style.color = '#1f2937';
            wordEl.style.animationDuration = fallDuration + 'ms';
            wordEl.dataset.word = JSON.stringify(randomWord);
            
            gameArea.appendChild(wordEl);
            
            // å–®å­—æ‰è½å®Œç•¢å¾Œç§»é™¤
            setTimeout(() => {
                if (wordEl.parentElement) {
                    wordEl.remove();
                    if (gameActive) {
                        combo = 0;
                        comboDisplay.textContent = `é€£æ“Š: 0`;
                    }
                }
            }, fallDuration);
        }

        // é–‹å§‹éŠæˆ²
        function startGame() {
            // æœ‰å…§å»ºå–®å­—åº«ï¼Œå¯ä»¥ç›´æ¥é–‹å§‹
            if (words.length === 0) {
                words = [...builtInWords];
            }
            
            gameActive = true;
            score = 0;
            combo = 0;
            difficultyLevel = 1;
            fallDuration = 8000;
            
            scoreDisplay.textContent = '0';
            comboDisplay.textContent = 'é€£æ“Š: 0';
            gameArea.innerHTML = '';
            startScreen.classList.add('hidden');
            
            spawnWord();
            
            // å®šæœŸç”Ÿæˆæ–°å–®å­—ï¼Œéš¨æ™‚é–“åŠ å¿«
            spawnInterval = setInterval(() => {
                if (gameActive) {
                    spawnWord();
                    
                    // å¢åŠ é›£åº¦
                    difficultyLevel += 0.1;
                    fallDuration = Math.max(3000, 8000 - (difficultyLevel * 200));
                }
            }, 3000);
        }

        // çµæŸéŠæˆ²
        function endGame() {
            gameActive = false;
            clearInterval(spawnInterval);
            gameArea.innerHTML = '';
            startScreen.classList.remove('hidden');
            showToast(`éŠæˆ²çµæŸï¼æœ€çµ‚å¾—åˆ†: ${score}`, 'success');
        }

        // æ–°å¢å–®å­—
        addWordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const word = wordInput.value.trim();
            const definition = defInput.value.trim();
            
            if (!word || !definition) {
                showToast('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š', 'error');
                return;
            }

            if (words.length >= 999) {
                showToast('å·²é”åˆ° 999 å€‹å–®å­—ä¸Šé™', 'error');
                return;
            }
            
            addWordBtn.disabled = true;
            addWordBtn.textContent = 'æ–°å¢ä¸­...';
            
            const result = await window.dataSdk.create({
                word: word,
                definition: definition,
                created_at: new Date().toISOString()
            });
            
            addWordBtn.disabled = false;
            addWordBtn.textContent = 'â• æ–°å¢å–®å­—';
            
            if (result.isOk) {
                wordInput.value = '';
                defInput.value = '';
                showToast('å–®å­—å·²æ–°å¢ï¼');
            } else {
                showToast('æ–°å¢å¤±æ•—', 'error');
            }
        });

        // é–‹å§‹æŒ‰éˆ•
        startButton.addEventListener('click', startGame);

        // Data SDK è™•ç†å™¨
        const dataHandler = {
            onDataChanged(data) {
                // åˆä½µå…§å»ºå–®å­—åº«å’Œä½¿ç”¨è€…æ–°å¢çš„å–®å­—
                const userWords = data.map(d => ({ word: d.word, definition: d.definition }));
                words = [...builtInWords, ...userWords].sort(() => Math.random() - 0.5);
                wordCount.textContent = `å…§å»º ${builtInWords.length} å€‹ + è‡ªè¨‚ ${userWords.length} å€‹ = å…± ${words.length} å€‹å–®å­—`;
                startButton.disabled = false;
                startButton.textContent = defaultConfig.start_button_text;
            }
        };

        // é…ç½®è®Šæ›´è™•ç†
        async function onConfigChange(config) {
            document.getElementById('gameTitle').textContent = config.game_title || defaultConfig.game_title;
            document.getElementById('scoreLabel').textContent = config.score_label || defaultConfig.score_label;
            
            if (words.length >= 4) {
                startButton.textContent = config.start_button_text || defaultConfig.start_button_text;
            }
            
            const bgStart = config.background_gradient_start || defaultConfig.background_gradient_start;
            const bgEnd = config.background_gradient_end || defaultConfig.background_gradient_end;
            document.querySelector('.h-full.w-full.overflow-hidden').style.background = 
                `linear-gradient(135deg, ${bgStart} 0%, ${bgEnd} 100%)`;
        }

        // ï¿½ï¿½å§‹åŒ–
        (async () => {
            const initResult = await window.dataSdk.init(dataHandler);
            if (!initResult.isOk) {
                showToast('è³‡æ–™è¼‰å…¥å¤±æ•—', 'error');
                return;
            }

            if (window.elementSdk) {
                window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.background_gradient_start || defaultConfig.background_gradient_start,
                                set: (value) => {
                                    config.background_gradient_start = value;
                                    window.elementSdk.setConfig({ background_gradient_start: value });
                                }
                            },
                            {
                                get: () => config.background_gradient_end || defaultConfig.background_gradient_end,
                                set: (value) => {
                                    config.background_gradient_end = value;
                                    window.elementSdk.setConfig({ background_gradient_end: value });
                                }
                            },
                            {
                                get: () => config.word_color || defaultConfig.word_color,
                                set: (value) => {
                                    config.word_color = value;
                                    window.elementSdk.setConfig({ word_color: value });
                                }
                            },
                            {
                                get: () => config.button_color || defaultConfig.button_color,
                                set: (value) => {
                                    config.button_color = value;
                                    window.elementSdk.setConfig({ button_color: value });
                                }
                            },
                            {
                                get: () => config.text_color || defaultConfig.text_color,
                                set: (value) => {
                                    config.text_color = value;
                                    window.elementSdk.setConfig({ text_color: value });
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["game_title", config.game_title || defaultConfig.game_title],
                        ["start_button_text", config.start_button_text || defaultConfig.start_button_text],
                        ["score_label", config.score_label || defaultConfig.score_label]
                    ])
                });
            }
        })();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9aeade28414bc4ed',t:'MTc2NTg1MzM2OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>